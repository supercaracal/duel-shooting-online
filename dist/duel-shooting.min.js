/*! duel-shooting 13-08-2016 */

var Action=Class.create({hasTouchEvent:null,hasMousedownEvent:null,hasKeydownEvent:null,nextCommand:null,sprite:null,initialize:function(){this.hasTouchEvent="function"==typeof new Element("div",{ontouchstart:"return;"}).ontouchstart,this.hasMousedownEvent="function"==typeof new Element("div",{onmousedown:"return;"}).onmousedown,this.hasKeydownEvent="function"==typeof new Element("div",{onkeydown:"return;"}).onkeydown,this.sprite=new Sprite,this.setEventListener()},setEventListener:function(){this.hasTouchEvent&&$(document).observe("touchstart",this.handlerTouch.bindAsEventListener(this)),this.hasMousedownEvent&&$(document).observe("mousedown",this.handlerMouse.bindAsEventListener(this)),this.hasKeydownEvent&&$(document).observe("keydown",this.handler.bindAsEventListener(this))},stop:function(){this.hasTouchEvent&&$(document).stopObserving("touchstart"),this.hasMousedownEvent&&$(document).stopObserving("mousedown"),this.hasKeydownEvent&&$(document).stopObserving("keydown")},getCommand:function(){var command=this.nextCommand;return this.nextCommand=null,command},handlerTouch:function(e){this.convertToAction(e.touches[0].pageX,e.touches[0].pageY)&&e.stop()},handlerMouse:function(e){this.convertToAction(e.pageX,e.pageY)&&e.stop()}}),AI=Class.create({ship:null,enemy:null,enemyWeapon:null,height:null,shipTop:null,risksByArea:null,wait:null,stayAreaIndexes:null,seekAreaIndex:null,initialize:function(ship,enemy,enemyWeapon){this.ship=ship,this.enemy=enemy,this.enemyWeapon=enemyWeapon,this.height=ship.getClientHeight(),this.shipTop=ship.getTop(),this.wait=0,this.stayAreaIndexes={}},getCommand:function(){return 0<this.wait?(--this.wait,null):(this.wait+=Math.floor(100*Math.random())%this.WAIT_MAX,this.updateStayAreaIndexes(),this.updateRisksByArea(),this.updateSeekAreaIndex(),this.getNextCommand(this.getRecommendedCommand()))},updateStayAreaIndexes:function(){this.stayAreaIndexes.ship=Math.floor((this.ship.getLeft()+45)/90),this.stayAreaIndexes.enemy=Math.floor((this.enemy.getLeft()+45)/90)},updateRisksByArea:function(){this.risksByArea=[0,0,0,0,0,0,0,0],this.enemyWeapon.elms.each(function(elm){if(elm.instanceOfBullet&&elm.instanceOfBullet()){var top=elm.getTop(),left=elm.getLeft(),risk=Math.floor(this.height-Math.abs(top-this.shipTop)),areaIndex=Math.floor((left+15)/90);this.risksByArea[7<areaIndex?7:areaIndex]+=risk}}.bind(this))},updateSeekAreaIndex:function(){for(var seekInfo={idx:null,minDiffEnemy:null,minRisk:null},i=0,length=this.risksByArea.size();i<length;++i){var diffEnemy=Math.abs(i-this.stayAreaIndexes.enemy);(null===seekInfo.minRisk||this.risksByArea[i]<seekInfo.minRisk||this.risksByArea[i]===seekInfo.minRisk&&diffEnemy<seekInfo.minDiffEnemy)&&(seekInfo.idx=i,seekInfo.minDiffEnemy=diffEnemy,seekInfo.minRisk=this.risksByArea[i])}this.seekAreaIndex=seekInfo.idx},getRecommendedCommand:function(){var shipLeftAreaIndex=Math.floor(this.ship.getLeft()/90),shipRightAreaIndex=Math.floor((this.ship.getLeft()+89)/90);return this.seekAreaIndex<this.stayAreaIndexes.ship||this.seekAreaIndex<shipLeftAreaIndex||this.seekAreaIndex<shipRightAreaIndex?this.ship.isEnemy?"stepRight":"stepLeft":this.stayAreaIndexes.ship<this.seekAreaIndex||shipLeftAreaIndex<this.seekAreaIndex||shipRightAreaIndex<this.seekAreaIndex?this.ship.isEnemy?"stepLeft":"stepRight":"attack"}}),Command=Class.create({ship:null,weapon:null,initialize:function(ship,weapon){this.ship=ship,this.weapon=weapon},execute:function(command){command&&command in this&&this[command]()}}),ShipCreater=Class.create({sounds:null,isEnemy:null,ship:null,weapon:null,initialize:function(sounds,isEnemy){this.sounds=sounds,this.isEnemy=isEnemy},createShip:Prototype.emptyFunction,createWeapon:Prototype.emptyFunction,createAction:Prototype.emptyFunction,createAI:Prototype.emptyFunction,createCommand:Prototype.emptyFunction}),Sprite=Class.create({Z_INDEX_BASE:3e3,clientHeight:null,clientWidth:null,elm:null,initTop:null,initLeft:null,initTransformRotate:null,currentTop:null,currentLeft:null,currentTransformRotate:null,initialize:function(){this.clientHeight=this.getClientHeight(),this.clientWidth=this.getClientWidth(),this.elm=this.createElement(),this.initTop=this.getInitTop(),this.initLeft=this.getInitLeft(),this.initTransformRotate=this.getInitTransformRotate(),this.setupPosition()},createElement:function(){return new Element("div")},getInitTop:function(){return 0},getInitLeft:function(){return 0},getInitTransformRotate:function(){return 0},setupPosition:function(){this.setPos({top:this.initTop,left:this.initLeft})},resetPosition:function(){this.clientHeight=this.getClientHeight(),this.clientWidth=this.getClientWidth(),this.setupPosition()},getClientHeight:function(){return 480},getClientWidth:function(){return 720},renderElement:function(){$(document.body).insert(this.elm)},getTop:function(){return this.currentTop},getLeft:function(){return this.currentLeft},getPos:function(){return{top:this.currentTop,left:this.currentLeft}},getTransformRotate:function(){return this.currentTransformRotate},setTop:function(px){this.elm.setStyle({top:px+"px"}),this.currentTop=px},setLeft:function(px){this.elm.setStyle({left:px+"px"}),this.currentLeft=px},setPos:function(pxs){void 0!==pxs.top&&this.setTop(pxs.top),void 0!==pxs.left&&this.setLeft(pxs.left)},setTransformRotate:function(theta){this.elm.setStyle({webkitTransform:"rotate("+theta+"deg)",MozTransform:"rotate("+theta+"deg)",msTransform:"rotate("+theta+"deg)",transform:"rotate("+theta+"deg)"}),this.currentTransformRotate=theta},setOpacity:function(v){this.elm.setOpacity(v)},remove:function(){this.elm.remove()}}),Bullet=Class.create(Sprite,{ship:null,enemy:null,isFall:null,isDelete:null,initialize:function($super,ship,enemy){this.ship=ship,this.enemy=enemy,this.isFall=ship.isEnemy,this.isDelete=!1,$super()},getInitTop:function(){return this.isFall?60:this.clientHeight-90},getInitLeft:function(){return this.ship.getLeft()+30},createElement:function(){var color=this.getColor(),outer=new Element("div").setStyle({width:"30px",height:"30px",zIndex:this.Z_INDEX_BASE+6,position:"fixed"}),inner=new Element("div").setStyle({width:"20px",height:"20px",margin:"5px",backgroundColor:color,borderRadius:"20px",boxShadow:"0px 0px 10px "+color});return inner.wrap(outer)},instanceOfBullet:function(){return!0}}),Funnel=Class.create(Sprite,{carrier:null,isEnemy:null,isDelete:null,initialize:function($super,carrier){this.carrier=carrier,this.isEnemy=carrier.isEnemy,this.isDelete=!1,$super()},createElement:function(){var color=this.getColor();return this.isEnemy?this.createForEnemy(color):this.createForShip(color)},createForShip:function(color){var obj=new Element("div").setStyle({width:"30px",height:"30px",zIndex:this.Z_INDEX_BASE+4,position:"fixed"});return obj.insert(new Element("div").setStyle({width:"6px",height:"20px",marginLeft:"12px",backgroundColor:color,borderRadius:"2px",boxShadow:"0px 0px 10px "+color})),obj.insert(new Element("div").setStyle({width:"20px",height:"10px",margin:"0px 5px 0px 5px",backgroundColor:color,borderRadius:"20px",boxShadow:"0px 0px 10px "+color})),obj},createForEnemy:function(color){var obj=new Element("div").setStyle({width:"30px",height:"30px",zIndex:this.Z_INDEX_BASE+4,position:"fixed"});return obj.insert(new Element("div").setStyle({width:"20px",height:"10px",margin:"0px 5px 0px 5px",backgroundColor:color,borderRadius:"20px",boxShadow:"0px 0px 10px "+color})),obj.insert(new Element("div").setStyle({width:"6px",height:"20px",marginLeft:"12px",backgroundColor:color,borderRadius:"2px",boxShadow:"0px 0px 10px "+color})),obj}}),Ship=Class.create(Sprite,{hitPoint:null,soundHit:null,soundLose:null,isEnemy:null,way:null,nextCmd:null,initialize:function($super,isEnemy){this.isEnemy=isEnemy,this.hitPoint=100,$super(),this.setHitPoint(this.hitPoint)},createElement:function(){var color=this.getColor();return this.isEnemy?this.createEnemy(color):this.createShip(color)},createEnemy:function(color){var elm=new Element("div").setStyle({width:"90px",height:"60px",zIndex:this.Z_INDEX_BASE+10,position:"fixed",top:"0px",left:"0px"});return elm.insert(new Element("div").setStyle({width:"90px",height:"30px",backgroundColor:color,borderRadius:"6px",boxShadow:"0px 0px 30px "+color,textAlign:"center",fontWeight:800,fontSize:"20px"}).update(this.hitPoint)),elm.insert(new Element("div").setStyle({width:"30px",height:"30px",backgroundColor:color,borderRadius:"6px",boxShadow:"0px 0px 30px "+color,marginLeft:"30px"})),elm},createShip:function(color){var elm=new Element("div").setStyle({width:"90px",height:"60px",zIndex:this.Z_INDEX_BASE+10,position:"fixed",top:this.clientHeight-60+"px",left:this.clientWidth-90+"px"});return elm.insert(new Element("div").setStyle({width:"30px",height:"30px",backgroundColor:color,borderRadius:"6px",boxShadow:"0px 0px 10px "+color,marginLeft:"30px"})),elm.insert(new Element("div").setStyle({width:"90px",height:"30px",backgroundColor:color,borderRadius:"6px",boxShadow:"0px 0px 10px "+color,textAlign:"center",fontWeight:800,fontSize:"20px"}).update(this.hitPoint)),elm},getInitTop:function(){return this.isEnemy?0:this.clientHeight-60},getInitLeft:function(){return this.isEnemy?0:this.clientWidth-90},setSoundHit:function(audio){this.soundHit=audio},setSoundLose:function(audio){this.soundLose=audio},playSoundHit:function(){this.soundHit&&this.soundHit.replay()},playSoundLose:function(){this.soundLose&&this.soundLose.replay()},hit:function(){this.hitPoint<1||(this.setHitPoint(--this.hitPoint),0===this.hitPoint?this.playSoundLose():this.playSoundHit())},isHit:function(bullet,range){var enemyLeft=this.getLeft(),enemyIField=this.getIField?this.getIField():null,top=bullet.getTop(),left=bullet.getLeft();return!(!enemyIField||!enemyIField.isHit(bullet,range,enemyLeft))||(enemyLeft-25<left&&left<=enemyLeft+5&&(bullet.isFall?top+range>this.clientHeight-60:top+range<30)?(this.hit(),!0):enemyLeft+5<left&&left<enemyLeft+60&&(bullet.isFall?top+range>this.clientHeight-90:top+range<60)?(this.hit(),!0):enemyLeft+60<=left&&left<enemyLeft+90&&(bullet.isFall?top+range>this.clientHeight-60:top+range<30)?(this.hit(),!0):top+range<0||this.clientHeight<top+range)},setHitPoint:function(num){this.hitPoint=num,this.elm.down(this.isEnemy?0:1).update(num)},getHitPoint:function(){return this.hitPoint},stepRight:function(){this.way=this.isEnemy?"left":"right"},stepLeft:function(){this.way=this.isEnemy?"right":"left"},moveRight:function(){var max=this.clientWidth-90;this.currentLeft+10<=max&&this.setLeft(this.currentLeft+10)},moveLeft:function(){var min=0;min<=this.currentLeft-10&&this.setLeft(this.currentLeft-10)},move:function(){null!==this.nextCmd&&"stepRight"!==this.nextCmd&&"stepLeft"!==this.nextCmd&&(this.way=null),"right"===this.way&&this.moveRight(),"left"===this.way&&this.moveLeft()}}),WeaponWaitStatus=Class.create(Sprite,{ship:null,isWeaponWaitStatus:!0,initialize:function($super,ship){this.ship=ship,$super()},createElement:function(){var color=this.getColor();return new Element("div").setStyle({width:"0px",height:"6px",backgroundColor:color,zIndex:this.Z_INDEX_BASE+11,position:"fixed",boxShadow:"0px 0px 1px "+color,borderRadius:"1px"})},getColor:function(){return"#FF0099"},getInitTop:function(){return this.ship.getTop()+(this.ship.isEnemy?42:12)},getInitLeft:function(){return this.ship.getLeft()+35},setWidth:function(current,max){this.elm.setStyle({width:Math.floor(20*current/max)+"px"})},move:function(){this.setLeft(this.ship.getLeft()+35)}}),ActionShipNavy=Class.create(Action,{KEY_A:65,KEY_S:83,KEY_D:68,KEY_F:70,KEY_Z:90,KEY_X:88,KEY_C:67,KEY_V:86,handler:function(e){if(!(e.altGraphKey||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.keyCode){case Event.KEY_RIGHT:this.nextCommand="stepRight",e.stop();break;case Event.KEY_LEFT:this.nextCommand="stepLeft",e.stop();break;case Event.KEY_UP:this.nextCommand="attack",e.stop();break;case this.KEY_A:this.nextCommand="attack1",e.stop();break;case this.KEY_S:this.nextCommand="attack2",e.stop();break;case this.KEY_D:this.nextCommand="attack3",e.stop();break;case this.KEY_F:this.nextCommand="attack4",e.stop();break;case this.KEY_Z:this.nextCommand="attack5",e.stop();break;case this.KEY_X:this.nextCommand="attack6",e.stop();break;case this.KEY_C:this.nextCommand="attack7",e.stop();break;case this.KEY_V:this.nextCommand="attack8",e.stop()}},convertToAction:function(x,y){var screenUpperPart=0<y&&y<this.sprite.clientHeight/2,screenLowerPart=this.sprite.clientHeight/2<y&&y<this.sprite.clientHeight,screenLeft=0<x&&x<this.sprite.clientWidth/3,screenCenter=this.sprite.clientWidth/3<x&&x<this.sprite.clientWidth/3*2,screenRight=this.sprite.clientWidth/3*2<x&&x<this.sprite.clientWidth;return screenLowerPart&&screenLeft?(this.nextCommand="stepLeft",!0):screenLowerPart&&screenCenter?(this.nextCommand="attack",!0):screenLowerPart&&screenRight?(this.nextCommand="stepRight",!0):screenUpperPart&&screenLeft?(this.nextCommand="stepLeft",!0):screenUpperPart&&screenCenter?(this.nextCommand="attack",!0):!(!screenUpperPart||!screenRight)&&(this.nextCommand="stepRight",!0)}}),ActionShipRed=Class.create(Action,{KEY_F:70,KEY_I:73,KEY_N:78,handler:function(e){if(!(e.altGraphKey||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.keyCode){case Event.KEY_RIGHT:this.nextCommand="stepRight",e.stop();break;case Event.KEY_LEFT:this.nextCommand="stepLeft",e.stop();break;case Event.KEY_UP:this.nextCommand="attack",e.stop();break;case this.KEY_I:this.nextCommand="barrier",e.stop();break;case this.KEY_F:this.nextCommand="funnel",e.stop();break;case this.KEY_N:this.nextCommand="avoid",e.stop()}},convertToAction:function(x,y){var screenUpperPart=0<y&&y<this.sprite.clientHeight/2,screenLowerPart=this.sprite.clientHeight/2<y&&y<this.sprite.clientHeight,screenLeft=0<x&&x<this.sprite.clientWidth/3,screenCenter=this.sprite.clientWidth/3<x&&x<this.sprite.clientWidth/3*2,screenRight=this.sprite.clientWidth/3*2<x&&x<this.sprite.clientWidth;return screenLowerPart&&screenLeft?(this.nextCommand="stepLeft",!0):screenLowerPart&&screenCenter?(this.nextCommand="avoid",!0):screenLowerPart&&screenRight?(this.nextCommand="stepRight",!0):screenUpperPart&&screenLeft?(this.nextCommand="funnel",!0):screenUpperPart&&screenCenter?(this.nextCommand="attack",!0):!(!screenUpperPart||!screenRight)&&(this.nextCommand="barrier",!0)}}),ActionShipWhite=Class.create(Action,{KEY_F:70,KEY_M:77,handler:function(e){if(!(e.altGraphKey||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey))switch(e.keyCode){case Event.KEY_RIGHT:this.nextCommand="stepRight",e.stop();break;case Event.KEY_LEFT:this.nextCommand="stepLeft",e.stop();break;case Event.KEY_UP:this.nextCommand="attack",e.stop();break;case Event.KEY_DOWN:this.nextCommand="wait",e.stop();break;case this.KEY_F:this.nextCommand="funnel",e.stop();break;case this.KEY_M:this.nextCommand="megaCannon",e.stop()}},convertToAction:function(x,y){var screenUpperPart=0<y&&y<this.sprite.clientHeight/2,screenLowerPart=this.sprite.clientHeight/2<y&&y<this.sprite.clientHeight,screenLeft=0<x&&x<this.sprite.clientWidth/3,screenCenter=this.sprite.clientWidth/3<x&&x<this.sprite.clientWidth/3*2,screenRight=this.sprite.clientWidth/3*2<x&&x<this.sprite.clientWidth;return screenLowerPart&&screenLeft?(this.nextCommand="stepLeft",!0):screenLowerPart&&screenCenter?(this.nextCommand="wait",!0):screenLowerPart&&screenRight?(this.nextCommand="stepRight",!0):screenUpperPart&&screenLeft?(this.nextCommand="funnel",!0):screenUpperPart&&screenCenter?(this.nextCommand="attack",!0):!(!screenUpperPart||!screenRight)&&(this.nextCommand="megaCannon",!0)}}),AIShipNavy=Class.create(AI,{WAIT_MAX:3,getNextCommand:function(recommendedCommand){if("attack"!==recommendedCommand||2..isTiming())return recommendedCommand;var idxs;switch(this.stayAreaIndexes.enemy){case 0:idxs=this.ship.isEnemy?[5,4,3]:[2,3,4];break;case 1:idxs=this.ship.isEnemy?[4,3,2]:[3,4,5];break;case 2:idxs=this.ship.isEnemy?[7,3,2]:[0,4,5];break;case 3:idxs=this.ship.isEnemy?[6,2,1]:[1,5,6];break;case 4:idxs=this.ship.isEnemy?[6,5,1]:[1,2,6];break;case 5:idxs=this.ship.isEnemy?[5,4,0]:[3,4,7];break;case 6:idxs=this.ship.isEnemy?[5,4,3]:[2,3,4];break;case 7:idxs=this.ship.isEnemy?[4,3,2]:[3,4,5]}return"attack"+(idxs[Math.floor(100*Math.random())%3]+1)}}),AIShipRed=Class.create(AI,{WAIT_MAX:7,funnelCount:0,getNextCommand:function(recommendedCommand){if(this.updateFunnelCount(),this.funnelCount<2)return this.isShipFixedOnArea()?"funnel":"stepLeft";if("attack"!==recommendedCommand)return this.isAvoidTiming(recommendedCommand)?"avoid":recommendedCommand;if(this.ship.isIFieldEnable())return"barrier";var iFieldInfo=this.ship.getIFieldInfo();return iFieldInfo.isActive||13..isTiming()?"funnel":recommendedCommand},updateFunnelCount:function(){var funnelInfo=this.ship.getFunnelInfo();null!==funnelInfo.firstLeft&&null!==funnelInfo.secondLeft?this.funnelCount=2:null!==funnelInfo.firstLeft&&null===funnelInfo.secondLeft?this.funnelCount=1:this.funnelCount=0},isShipFixedOnArea:function(){return 0===this.funnelCount&&this.stayAreaIndexes.ship===(this.ship.isEnemy?1:6)||1===this.funnelCount&&this.stayAreaIndexes.ship===(this.ship.isEnemy?6:1)},isAvoidTiming:function(recommendedCommand){return 49..isTiming()&&(!this.ship.isEnemy&&"stepLeft"===recommendedCommand&&3<this.stayAreaIndexes.ship||!this.ship.isEnemy&&"stepRight"===recommendedCommand&&this.stayAreaIndexes.ship<4||this.ship.isEnemy&&"stepLeft"===recommendedCommand&&this.stayAreaIndexes.ship<4||this.ship.isEnemy&&"stepRight"===recommendedCommand&&3<this.stayAreaIndexes.ship)}}),AIShipWhite=Class.create(AI,{WAIT_MAX:3,getNextCommand:function(recommendedCommand){return"attack"!==recommendedCommand?recommendedCommand:this.ship.isMegaCannonEnabled&&Math.abs(this.stayAreaIndexes.enemy-this.stayAreaIndexes.ship)<3?"megaCannon":this.ship.isNotFunnelEmpty&&this.stayAreaIndexes.ship!==this.stayAreaIndexes.enemy?"funnel":49..isTiming()&&13..isTiming()?"wait":recommendedCommand}}),CommandShipNavy=Class.create(Command,{stepRight:function(){this.ship.stepRight()},stepLeft:function(){this.ship.stepLeft()},attack:function(){this.weapon.addBulletBezierAuto()},attack1:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?660:30)},attack2:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?570:120)},attack3:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?480:210)},attack4:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?390:300)},attack5:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?300:390)},attack6:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?210:480)},attack7:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?120:570)},attack8:function(){this.weapon.addBulletBezierManual(this.ship.isEnemy?30:660)}}),CommandShipRed=Class.create(Command,{stepRight:function(){this.ship.stepRight()},stepLeft:function(){this.ship.stepLeft()},avoid:function(){this.ship.avoid()},barrier:function(){this.ship.barrier()},attack:function(){this.ship.iField&&this.ship.iField.isActive||this.weapon.addBulletHoming()},funnel:function(){this.weapon.addFunnelCircle()}}),CommandShipWhite=Class.create(Command,{stepRight:function(){this.ship.stepRight()},stepLeft:function(){this.ship.stepLeft()},wait:Prototype.emptyFunction,attack:function(){this.weapon.addBulletLinear()},funnel:function(){this.weapon.addFunnelSlider()},megaCannon:function(){this.weapon.fireMegaCannon()}}),ShipCreaterNavy=Class.create(ShipCreater,{createShip:function(){return this.ship=new ShipNavy(this.isEnemy),this.isEnemy||(this.ship.setSoundHit(this.sounds.hit),this.ship.setSoundLose(this.sounds.lose)),this.ship},createWeapon:function(enemy){return this.weapon=new Weapon(this.ship,enemy),this.isEnemy?this.weapon:(this.weapon.setSoundAttack(this.sounds.attack),this.weapon)},createAction:function(){return new ActionShipNavy},createAI:function(enemy,enemyWeapon){return new AIShipNavy(this.ship,enemy,enemyWeapon)},createCommand:function(){return new CommandShipNavy(this.ship,this.weapon)}}),ShipCreaterRed=Class.create(ShipCreater,{createShip:function(){return this.ship=new ShipRed(this.isEnemy),this.isEnemy||(this.ship.setSoundHit(this.sounds.hit),this.ship.setSoundLose(this.sounds.lose),this.ship.setSoundNewtype(this.sounds.newtype)),this.ship},createWeapon:function(enemy){return this.weapon=new Weapon(this.ship,enemy),this.isEnemy?this.weapon.addIField():this.weapon.addIField(this.sounds.iField),this.weapon.addFunnelDefences(),this.isEnemy?this.weapon:(this.weapon.setSoundAttack(this.sounds.attack),this.weapon.setSoundFunnelGo(this.sounds.funnelGo),this.weapon.setSoundFunnelAttack(this.sounds.funnelAtk),this.weapon)},createAction:function(){return new ActionShipRed},createAI:function(enemy,enemyWeapon){return new AIShipRed(this.ship,enemy,enemyWeapon)},createCommand:function(){return new CommandShipRed(this.ship,this.weapon)}}),ShipCreaterWhite=Class.create(ShipCreater,{createShip:function(){return this.ship=new ShipWhite(this.isEnemy),this.isEnemy||(this.ship.setSoundHit(this.sounds.hit),this.ship.setSoundLose(this.sounds.lose)),this.ship},createWeapon:function(enemy){return this.weapon=new Weapon(this.ship,enemy),this.weapon.addWeaponWaitStatusMegaCannon(),this.isEnemy?this.weapon:(this.weapon.setSoundAttack(this.sounds.attack),this.weapon.setSoundMegaCannon(this.sounds.megaCannon),this.weapon.setSoundFunnelGo(this.sounds.funnelGo),this.weapon.setSoundFunnelAttack(this.sounds.funnelAtk),this.weapon)},createAction:function(){return new ActionShipWhite},createAI:function(enemy,enemyWeapon){return new AIShipWhite(this.ship,enemy,enemyWeapon)},createCommand:function(){return new CommandShipWhite(this.ship,this.weapon)}}),ShipFactory={};ShipFactory.getCreater=function(color,isEnemy,sounds){return new(window["ShipCreater"+color.capitalize()])(sounds,isEnemy)};var DuelShootingDemo=Class.create({opening:null,colors:null,sounds:null,factories:null,ships:null,weapons:null,actions:null,ais:null,cmds:null,background:null,timekeeper:null,condition:null,game:null,initialize:function(){this.opening=new Opening(new Title),this.opening.show(),Number.prototype.isTiming=function(num){return Math.floor(100*Math.random())%num===0}.methodize(),this.setupColor(),this.setupSound(),this.setupFactories(),this.setupShips(),this.setupWeapons(),this.setupActions(),this.setupAIs(),this.setupCommands(),this.background=new Background,this.timekeeper=new TimeKeeper,this.condition=new Condition,this.game=new Game(this.routine.bind(this)),this.renderElements(),function(){this.opening.hide(),this.start()}.bind(this).delay(3)},setupColor:function(){this.colors={a:["white","red","navy"][Math.floor(100*Math.random())%3],b:["white","red","navy"][Math.floor(100*Math.random())%3]}},setupSound:function(){new Sound;this.sounds={}},setupFactories:function(){this.factories={},this.factories.a=ShipFactory.getCreater(this.colors.a,!1,this.sounds),this.factories.b=ShipFactory.getCreater(this.colors.b,!0,this.sounds)},setupShips:function(){this.ships={},this.ships.a=this.factories.a.createShip(),this.ships.b=this.factories.b.createShip()},setupWeapons:function(){this.weapons={},this.weapons.a=this.factories.a.createWeapon(this.ships.b),this.weapons.b=this.factories.b.createWeapon(this.ships.a)},setupActions:function(){this.actions={},this.actions.a=null,this.actions.b=null},setupAIs:function(){this.ais={},this.ais.a=this.factories.a.createAI(this.ships.b,this.weapons.b),this.ais.b=this.factories.b.createAI(this.ships.a,this.weapons.a)},setupCommands:function(){this.cmds={},this.cmds.a=this.factories.a.createCommand(),this.cmds.b=this.factories.b.createCommand()},routine:function(){this.ships.a.move(),this.ships.b.move(),this.weapons.a.move(),this.weapons.b.move(),this.ships.b.getHitPoint()||(this.condition.update("You win.","#9999FF"),(new ForkMeOnGitHub).renderElement(),this.stop()),this.ships.a.getHitPoint()||(this.condition.update("You lose.","#FF9999"),(new ForkMeOnGitHub).renderElement(),this.stop());var nextActions={a:this.ais.a.getCommand(),b:this.ais.b.getCommand()};this.ships.a.nextCmd=nextActions.a,this.ships.b.nextCmd=nextActions.b,this.cmds.a.execute(nextActions.a),this.cmds.b.execute(nextActions.b)},renderElements:function(){this.background.renderElement(),this.timekeeper.renderElement(),this.condition.renderElement(),this.ships.a.renderElement(),this.ships.b.renderElement()},start:function(){this.game.start(),this.timekeeper.start()},stop:function(){this.timekeeper.stop(),this.game.stop()}}),DuelShootingOffline=Class.create(DuelShootingDemo,{setupSound:function(){var sound=new Sound;this.sounds={},this.sounds.hit=sound.createAudio("/se/hit.mp3"),this.sounds.lose=sound.createAudio("/se/lose.mp3"),this.sounds.newtype=sound.createAudio("/se/newtype.mp3"),this.sounds.attack=sound.createAudio("/se/attack.mp3"),this.sounds.megaCannon=sound.createAudio("/se/mega.mp3"),this.sounds.funnelGo=sound.createAudio("/se/funnel1.mp3"),this.sounds.funnelAtk=sound.createAudio("/se/funnel2.mp3"),this.sounds.iField=sound.createAudio("/se/at_field.mp3")},setupActions:function(){this.actions={},this.actions.a=this.factories.a.createAction(),this.actions.b=null},setupAIs:function(){this.ais={},this.ais.a=null,this.ais.b=this.factories.b.createAI(this.ships.a,this.weapons.a)},routine:function(){this.ships.a.move(),this.ships.b.move(),this.weapons.a.move(),this.weapons.b.move(),this.ships.b.getHitPoint()||(this.condition.update("You win.","#9999FF"),(new ForkMeOnGitHub).renderElement(),this.stop()),this.ships.a.getHitPoint()||(this.condition.update("You lose.","#FF9999"),this.stop());var nextActions={a:this.actions.a.getCommand(),b:this.ais.b.getCommand()};this.ships.a.nextCmd=nextActions.a,this.ships.b.nextCmd=nextActions.b,this.cmds.a.execute(nextActions.a),this.cmds.b.execute(nextActions.b)},stop:function(){this.actions.a.stop(),this.timekeeper.stop(),this.game.stop()}}),DuelShootingOnline=Class.create({sounds:null,weapons:null,cmds:null,opening:null,condition:null,sync:null,timeKeeper:null,ship:null,enemy:null,action:null,game:null,initialize:function(){this.weapons={},this.cmds={},this.opening=new Opening(new Title),this.condition=new Condition,this.opening.show(),this.condition.renderElement(),this.condition.update("Please wait for player matching.","#99FF99"),this.setupSoundEffect(),this.sync=new Synchronizer("/",this.callback.bind(this),this.finish.bind(this))},callback:function(data){var creater={};creater.ship=ShipFactory.getCreater(data.ship,!1,this.sounds),creater.enemy=ShipFactory.getCreater(data.enemy,!0,this.sounds),this.ship=creater.ship.createShip(),this.enemy=creater.enemy.createShip(),this.weapons.ship=creater.ship.createWeapon(this.enemy),this.weapons.enemy=creater.enemy.createWeapon(this.ship),this.action=creater.ship.createAction(),this.cmds.ship=creater.ship.createCommand(),this.cmds.enemy=creater.enemy.createCommand(),this.sync.setShipAndCommand(data.ship,this.ship,this.cmds.ship),this.sync.setShipAndCommand(data.enemy,this.enemy,this.cmds.enemy),this.sync.listenShipCommand(),this.setShipRedWeaponForSync(data),this.setupTimeKeeper(),this.setupGame(),this.renderElements(),this.game.start(),this.timeKeeper.start(),this.condition.updateAndDelayHide("Engaged!","#FF9999"),this.opening.hide()},setupSoundEffect:function(){var sound=new Sound;this.sounds={},this.sounds.hit=sound.createAudio("/se/hit.mp3"),this.sounds.lose=sound.createAudio("/se/lose.mp3"),this.sounds.newtype=sound.createAudio("/se/newtype.mp3"),this.sounds.attack=sound.createAudio("/se/attack.mp3"),this.sounds.megaCannon=sound.createAudio("/se/mega.mp3"),this.sounds.funnelGo=sound.createAudio("/se/funnel1.mp3"),this.sounds.funnelAtk=sound.createAudio("/se/funnel2.mp3"),this.sounds.iField=sound.createAudio("/se/at_field.mp3")},setShipRedWeaponForSync:function(data){var prop;"red"==data.ship&&(prop="ship"),"red"==data.enemy&&(prop="enemy"),prop&&this.sync.setShipRedWeapon(this.weapons[prop])},setupTimeKeeper:function(){this.timeKeeper=new TimeKeeper},setupGame:function(){this.game=new Game(this.routine.bind(this))},routine:function(){if(this.sync.chat.move(),this.ship.move(),this.enemy.move(),this.weapons.ship.move(),this.weapons.enemy.move(),this.action)return 0===this.ship.getHitPoint()?void this.finish(!1):void this.pushCommand(this.action.getCommand())},finish:function(isWin){this.action.stop(),this.timeKeeper.stop(),this.game.stop(),this.sync.stop(),this.condition.update(isWin?"You win.":"You lose.",isWin?"#9999FF":"#FF9999"),isWin&&(new ForkMeOnGitHub).renderElement()},pushCommand:function(cmd){this.sync.pushAttackInfo(cmd)},renderElements:function(){(new Background).renderElement(),this.timeKeeper.renderElement(),this.ship.renderElement(),this.enemy.renderElement()}}),Game=Class.create({INTERVAL_WAIT_MSEC:16,timerId:null,routine:null,initialize:function(routine){this.routine=routine},start:function(){null===this.timerId&&(this.timerId=setInterval(this.routine,this.INTERVAL_WAIT_MSEC))},pause:function(){null===this.timerId?this.start():this.stop()},stop:function(){clearInterval(this.timerId),this.timerId=null}}),Sound=Class.create({hasAudioElement:null,initialize:function(){this.hasAudioElement=this.checkAudio(),this.addAudioMethods()},checkAudio:function(){var canPlayMpeg="function"==typeof Audio&&"HTMLAudioElement"==Audio.name&&"function"==typeof Audio.prototype.canPlayType&&(new Audio).canPlayType("audio/mpeg");return"probably"==canPlayMpeg||"maybe"==canPlayMpeg},addAudioMethods:function(){this.hasAudioElement&&Element.addMethods("audio",{stop:function(audio){try{audio.currentTime=0}catch(e){console&&console.log(e)}},replay:function(audio){try{audio.currentTime=0,audio.play()}catch(e){console&&console.log(e)}}})},createAudio:function(src){if(this.hasAudioElement){var audio=new Element("audio",{src:src});return Prototype.Browser.MobileSafari&&audio.load(),audio}return null}}),Background=Class.create(Sprite,{createElement:function(){return new Element("div").setStyle({display:"block",position:"fixed",zIndex:this.Z_INDEX_BASE,backgroundColor:"#333333",height:this.clientHeight+"px",width:this.clientWidth+"px",borderRight:"solid 1px #AAAAAA",borderBottom:"solid 1px #AAAAAA"}).setOpacity(.8)},resetPosition:function($super){$super(),this.elm.setStyle({height:this.clientHeight+"px",width:this.clientWidth+"px"})}}),BulletBezier=Class.create(Bullet,{ATTAINABLE_COUNT:40,pos:null,leftRange:null,topRange:null,count:null,initialize:function($super,ship,enemy,left){$super(ship,enemy),this.pos={ship:{top:ship.getTop()+(this.isFall?60:-30),left:ship.getLeft()+30},enemy:{top:enemy.getTop()+(this.isFall?-30:60),left:left}},this.leftRange=-(this.pos.ship.left-this.pos.enemy.left)/this.ATTAINABLE_COUNT,this.topRange=-(this.pos.ship.top-this.pos.enemy.top)/this.ATTAINABLE_COUNT,this.count=0},getColor:function(){return"#FFFF33"},move:function(){if(++this.count,this.enemy.isHit(this,this.topRange))return this.isDelete=!0,void this.elm.remove();var left=this.pos.ship.left+this.leftRange*this.count;this.setPos({top:this.pos.ship.top+this.topRange*this.count*this.count/this.ATTAINABLE_COUNT,left:left+(this.pos.enemy.left-left)*this.count/this.ATTAINABLE_COUNT})}}),BulletHoming=Class.create(Bullet,{getColor:function(){return"#FF55FF"},move:function(){var range=this.isFall?5:-5;if(this.enemy.isHit(this,range))return this.isDelete=!0,void this.elm.remove();var top=this.getTop(),left=this.getLeft(),enemyLeft=this.enemy.getLeft();(this.isFall?this.clientHeight/2<top:this.clientHeight/2>top)?(range=3*range,distance=0):left<enemyLeft?distance=10:enemyLeft+60<left?distance=-10:distance=0,this.setPos({top:top+range,left:left+distance})}}),BulletLinear=Class.create(Bullet,{getColor:function(){return"#55FF55"},move:function(){var range=this.isFall?10:-10;return this.enemy.isHit(this,range)?(this.isDelete=!0,void this.elm.remove()):void this.setTop(this.getTop()+range)}}),ChatForm=Class.create(Sprite,{textField:null,createElement:function(){var form=new Element("form",{action:"#",method:"post"}).setStyle({zIndex:this.Z_INDEX_BASE+2e3,position:"fixed",backgroundColor:"#EFEFEF"});this.textField=new Element("input",{type:"text",value:""}).setStyle({
width:"400px"});var button=new Element("input",{type:"submit",value:"send"});return form.insert(this.textField).insert(button),form},getInitTop:function(){return this.clientHeight+10},getInitLeft:function(){return 270},getValue:function(){return $F(this.textField)}}),Condition=Class.create(Sprite,{timerId:null,createElement:function(){return new Element("div").setStyle({display:"none",position:"fixed",zIndex:this.Z_INDEX_BASE+101,fontSize:"20px",fontWeight:800,top:"0px",left:"0px"})},setupPosition:function(){var dim=this.elm.getDimensions();this.elm.setStyle({display:"block",top:this.clientHeight/2-(dim.height/2-0)+100+"px",left:this.clientWidth/2-(dim.width/2-0)+"px"})},update:function(text,color){this.timerId&&clearTimeout(this.timerId),this.elm.update(text),this.elm.setStyle({color:color}),this.setupPosition(),this.elm.show()},updateAndDelayHide:function(text,color){this.update(text,color),this.timerId=this.elm.hide.bind(this.elm).delay(7)}}),DuelistCounter=Class.create(Sprite,{createElement:function(){return new Element("div").setStyle({position:"fixed",zIndex:this.Z_INDEX_BASE,fontSize:"20px",fontWeight:800})},getInitTop:function(){return this.clientHeight+10},getInitLeft:function(){return 10},update:function(text){this.elm.update(text),this.remove(),this.renderElement()}}),ForkMeOnGitHub=Class.create(Sprite,{createElement:function(){return new Element("img",{src:"https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png",alt:"Fork me on GitHub"}).setStyle({border:"none"}).wrap(new Element("a",{href:"https://github.com/supercaracal/duelshooting_online"})).setStyle({position:"fixed",zIndex:this.Z_INDEX_BASE+4e3})},getInitTop:function(){return 0},getInitLeft:function(){return 0}}),FunnelCircle=Class.create(Funnel,{r:null,theta:null,speed:null,isClockwise:null,initialize:function($super,carrier){$super(carrier),this.r=70,this.theta=this.isEnemy?0:180,this.speed=3,this.isCloclwise=this.isEnemy},getInitTop:function(){return this.carrier.getTop()+(this.isEnemy?60:-30)},getInitLeft:function(){return this.carrier.getLeft()+30},getColor:function(){return"#FF9900"},move:function(){var y=this.initLeft+Math.sin(Math.PI/180*this.theta)*this.r,x=this.initTop+(this.isEnemy?0:-140)+this.r-Math.cos(Math.PI/180*this.theta)*this.r;this.setPos({top:x,left:y}),this.theta+=this.isClockwise?this.speed:-this.speed,(this.theta<0||360<this.theta)&&(this.theta=this.isClockwise?0:360)}}),FunnelDefenceLeft=Class.create(Funnel,{iField:null,initialize:function($super,carrier,iField){this.iField=iField,$super(carrier),this.setTransformRotate(this.getInitTransformRotate())},getInitTop:function(){return this.carrier.getTop()+(this.isEnemy?60:-30)},getInitLeft:function(){return this.carrier.getLeft()-40},getInitTransformRotate:function(){return 135},getColor:function(){return"#FF9900"},move:function(){if(this.iField.isActive)this.setTransformRotate(this.isEnemy?270:90);else{var deg=this.getTransformRotate();deg=deg>360?0:deg,this.setTransformRotate(++deg)}this.setPos({top:this.getInitTop(),left:this.getInitLeft()})}}),FunnelDefenceRight=Class.create(Funnel,{iField:null,initialize:function($super,carrier,iField){this.iField=iField,$super(carrier),this.setTransformRotate(this.getInitTransformRotate())},getInitTop:function(){return this.carrier.getTop()+(this.isEnemy?60:-30)},getInitLeft:function(){return this.carrier.getLeft()+100},getInitTransformRotate:function(){return 225},getColor:function(){return"#FF9900"},move:function(){if(this.iField.isActive)this.setTransformRotate(this.isEnemy?90:270);else{var deg=this.getTransformRotate();deg=deg<0?360:deg,this.setTransformRotate(--deg)}this.setPos({top:this.getInitTop(),left:this.getInitLeft()})}}),FunnelSlider=Class.create(Funnel,{target:null,isComeback:null,isFunnelSliderAttack:null,isFunnelSlider:null,initialize:function($super,carrier,target){this.isComeback=!1,this.isFunnelSliderAttack=!1,this.isFunnelSlider=!0,this.target=target,$super(carrier)},getInitTop:function(){return this.carrier.getTop()+(this.isEnemy?60:-30)},getInitLeft:function(){return this.carrier.getLeft()+30},getColor:function(){return"#9999FF"},move:function(){this.isComeback?this.moveComeback():this.moveChase()},moveComeback:function(){var shipCenterLeft=this.carrier.getLeft()+30,left=this.getLeft();return Math.abs(shipCenterLeft-left)<30?(this.isDelete=!0,void this.elm.remove()):void this.setLeft(left+(shipCenterLeft-left>0?10:-10))},moveChase:function(){var enemyCenterLeft=this.target.getLeft()+30,left=this.getLeft();return Math.abs(enemyCenterLeft-left)<30?(this.isComeback=!0,void(this.isFunnelSliderAttack=!0)):void this.setLeft(left+(enemyCenterLeft-left>0?10:-10))}}),IField=Class.create(Sprite,{WAIT:250,isActive:null,carrier:null,isEnemy:null,waitCount:null,sound:null,waitStatus:null,initialize:function($super,carrier){this.isActive=!1,this.carrier=carrier,this.isEnemy=carrier.isEnemy,this.waitCount=0,$super(),this.carrier.setIField(this)},createElement:function(){var color="#FFFFFF";return new Element("div").setStyle({width:"100px",height:"20px",backgroundColor:color,zIndex:this.Z_INDEX_BASE+11,position:"fixed",boxShadow:"0px 0px 10px "+color,borderRadius:"10px",display:"none"}).setOpacity(.5)},getInitTop:function(){return this.carrier.getTop()+(this.isEnemy?65:-25)},getInitLeft:function(){return this.carrier.getLeft()-5},getHeight:function(){return this.elm.getHeight()},setHeight:function(h){this.elm.setStyle({height:h+"px"}),this.setTop(this.getInitTop()+(20-h)/2)},setSound:function(audio){this.sound=audio},setWaitStatus:function(waitStatus){this.waitStatus=waitStatus},playSound:function(){this.sound&&this.sound.replay()},hit:function(){h=this.getHeight(),h-=2,this.setHeight(h),h<=0&&(this.cancel(),this.waitCount=this.WAIT)},isHit:function(bullet,range,enemyLeft){var top=bullet.getTop(),left=bullet.getLeft();if(this.isActive&&(bullet.isFall?top+range>this.clientHeight-110:top+range<80)&&enemyLeft-25<left&&left<enemyLeft+95)return this.hit(),!0},barrier:function(){0<this.waitCount||this.isActive||(this.setHeight(20),this.invoke(),this.playSound())},invoke:function(){this.isActive=!0,this.elm.show()},cancel:function(){this.isActive=!1,this.elm.hide()},move:function(){this.setLeft(this.carrier.getLeft()-5),this.isActive&&this.changeColor(),0<this.waitCount&&--this.waitCount,this.waitStatus.setWidth(this.waitCount,this.WAIT)},changeColor:function(){var color="#"+Math.floor(100*Math.random()).toColorPart()+Math.floor(100*Math.random()).toColorPart()+Math.floor(100*Math.random()).toColorPart();this.elm.setStyle({backgroundColor:color})}}),NicoNico=Class.create(Sprite,{text:null,dim:null,seed:null,initialize:function($super,text){this.text=text,this.seed=this.getSeed(),$super()},createElement:function(){return new Element("span").setStyle({color:this.getColor(),fontSize:this.getSeed()+8+"px",fontWeight:"bolder",zIndex:this.Z_INDEX_BASE+1e3+this.getSeed()+1,position:"fixed",whiteSpace:"nowrap"}).update(this.text)},getInitTop:function(){return Math.floor(this.clientHeight*(this.getSeed()/100))},getInitLeft:function(){return document.viewport.getWidth()||document.documentElement.clientWidth||document.body.clientWidth||document.body.scrollWidth||this.clientWidth},renderElement:function($super){$super(),this.dim=this.elm.getDimensions(),this.clientHeight<this.getTop()+this.dim.height&&this.setTop(this.clientHeight-this.dim.height)},move:function(){var x=this.getLeft();return x<-this.dim.width?(this.isDelete=!0,void this.remove()):(x-=this.seed%10+5,void this.setLeft(x))},getSeed:function(){return Math.floor(100*Math.random())},getColor:function(){var color=null,changePos=this.getSeed()%6,changeVal=this.getSeed()%16,hexs={0:"0F",1:"1F",2:"2F",3:"3F",4:"4F",5:"5F",6:"6F",7:"7F",8:"8F",9:"9F",10:"AF",11:"BF",12:"CF",13:"DF",14:"EF",15:"FF"};switch(changePos){case 0:color="#"+hexs[changeVal]+"FFFF";break;case 1:color="#FF"+hexs[changeVal]+"FF";break;case 2:color="#FFFF"+hexs[changeVal];break;case 3:color="#"+hexs[changeVal]+hexs[changeVal]+"FF";break;case 4:color="#"+hexs[changeVal]+"FF"+hexs[changeVal];break;case 5:color="#FF"+hexs[changeVal]+hexs[changeVal];break;default:color="#FFFFFF"}return color}}),Opening=Class.create(Sprite,{timerId:null,title:null,titleOpacity:0,backgroundOpacity:1,initialize:function($super,title){this.title=title,$super()},createElement:function(){var background=new Element("div").setStyle({display:"block",position:"fixed",zIndex:this.Z_INDEX_BASE+100,backgroundColor:"#111111",height:this.clientHeight+"px",width:this.clientWidth+"px"}).setOpacity(this.backgroundOpacity);return background},show:function(){this.title.renderElement(),this.renderElement(),this.timerId=setInterval(this.appear.bind(this),128)},appear:function(){this.titleOpacity>=1&&clearInterval(this.timerId),this.titleOpacity+=.1,this.title.setOpacity(this.titleOpacity)},hide:function(){clearInterval(this.timerId),this.title.remove(),this.timerId=setInterval(this.fade.bind(this),32)},fade:function(){this.backgroundOpacity<=0&&(clearInterval(this.timerId),this.elm.remove()),this.backgroundOpacity-=.1,this.elm.setOpacity(this.backgroundOpacity)}}),ShipAfterimage=Class.create(Ship,{getColor:function(){return"#FF5555"},spot:function(top,left,hitPoint){this.elm.setOpacity(.2),this.setPos({top:top,left:left}),this.setHitPoint(hitPoint),this.renderElement(),function(){this.elm.remove()}.bind(this).delay(.3)}}),ShipNavy=Class.create(Ship,{shadowSize:20,colors:["FF0000","FF6600","FFFF00","00FF00","00FFFF","0000FF","990099"],getColor:function(){return"#0F0F3F"},createElement:function($super){return $super().setStyle({color:"#FFFFFF"})},move:function($super){$super(),++this.shadowSize;var color="#"+this.colors[0];this.elm.down().setStyle({boxShadow:"0px 0px "+this.shadowSize+"px "+color}),this.elm.down(1).setStyle({boxShadow:"0px 0px "+this.shadowSize+"px "+color}),50<this.shadowSize&&(this.shadowSize=20,this.colors.push(this.colors.shift()))}}),ShipRed=Class.create(Ship,{soundNewtype:null,iField:null,funnels:null,initialize:function($super,isEnemy){$super(isEnemy),this.funnels=[]},getColor:function(){return"#FF5555"},setSoundNewtype:function(audio){this.soundNewtype=audio},playSoundNewtype:function(){this.soundNewtype&&this.soundNewtype.replay()},setIField:function(iField){this.iField=iField},getIField:function(){return this.iField},getIFieldInfo:function(){return{isActive:this.iField.isActive,height:this.iField.getHeight()}},getFunnelInfo:function(){return{firstLeft:this.funnels[0]?this.funnels[0].initLeft:null,firstTheta:this.funnels[0]?this.funnels[0].theta:null,secondLeft:this.funnels[1]?this.funnels[1].initLeft:null,secondTheta:this.funnels[1]?this.funnels[1].theta:null}},addFunnel:function(funnel){this.funnels.push(funnel)},isIFieldEnable:function(){return!this.iField.isActive&&!this.iField.waitCount},barrier:function(){this.iField.barrier()},avoid:function(){var sign=this.getLeft()+45<this.clientWidth/2?1:-1,top=this.getTop(),left=this.getLeft();this.setLeft(left+90*sign),[left,left+30*sign,left+60*sign].each(function(left){var shadow=new ShipAfterimage(this.isEnemy);shadow.spot(top,left,this.hitPoint)}.bind(this)),this.playSoundNewtype()}}),ShipWhite=Class.create(Ship,{isMegaCannonEnabled:!0,isNotFunnelEmpty:!0,getColor:function(){return"#FFFFFF"},enableMegaCannonStatus:function(){this.isMegaCannonEnabled=!0},disableMegaCannonStatus:function(){this.isMegaCannonEnabled=!1},enableFunnelStatus:function(){this.isNotFunnelEmpty=!0},disableFunnelStatus:function(){this.isNotFunnelEmpty=!1}}),TimeKeeper=Class.create(Sprite,{timerId:null,time:null,initialize:function($super){this.time=0,$super()},createElement:function(){return new Element("div").setStyle({zIndex:this.Z_INDEX_BASE+20,position:"fixed",height:"30px",width:"100px",fontSize:"20px",fontWeight:800,color:"#FFFFFF",textAlign:"right"}).update(this.time)},getInitTop:function(){return 2},getInitLeft:function(){return this.clientWidth-110},increment:function(){this.elm.update(++this.time)},start:function(){null===this.timerId&&(this.timerId=setInterval(this.increment.bind(this),1e3))},stop:function(){clearInterval(this.timerId),this.timerId=null}}),Title=Class.create(Sprite,{TITLE_TEXT:"Duel Shooting",createElement:function(){return new Element("div").setStyle({display:"none",position:"fixed",zIndex:this.Z_INDEX_BASE+101,fontSize:"36px",color:"#FFFFFF",top:"0px",left:"0px"}).update(this.TITLE_TEXT).setOpacity(0)},setupPosition:function(){this.renderElement();var dim=this.elm.getDimensions();this.elm.setStyle({display:"block",top:this.clientHeight/2-(dim.height/2-0)+"px",left:this.clientWidth/2-(dim.width/2-0)+"px"}),this.remove()}}),WeaponWaitStatusIField=Class.create(WeaponWaitStatus,{getColor:function(){return"#99FF00"}}),WeaponWaitStatusMegaCannon=Class.create(WeaponWaitStatus,{isWeaponWaitStatusMegaCannon:!0}),Synchronizer=Class.create({socket:null,controlShip:null,ships:null,cmds:null,weapons:null,chat:null,duelistCounter:null,chatForm:null,initialize:function(uri,callback,finish){this.ships={},this.cmds={},this.weapons={},this.chat=new Chat,this.duelistCounter=new DuelistCounter,this.duelistCounter.renderElement(),this.chatForm=new ChatForm,this.chatForm.renderElement(),this.socket=io.connect(uri),this.setupChatEvent(),this.listenShipControl(),this.listenDuelReady(callback),this.listenYouWin(finish),this.listenDuelistCount(),this.socket.emit("duty",{})},setupChatEvent:function(){this.chatForm.elm.observe("submit",function(e){e.stop();var v=this.chatForm.getValue();v&&this.socket.emit("chat",v)}.bindAsEventListener(this)),this.socket.on("chat",function(data){this.chat.add(data)}.bind(this))},listenShipControl:function(){this.socket.on("You have control",this.youHaveControl.bind(this)),this.socket.on("You have no control",this.youHaveNoControl.bind(this))},listenDuelReady:function(callback){this.socket.on("ready",callback)},listenYouWin:function(finish){this.socket.on("You win",finish)},listenDuelistCount:function(){this.socket.on("duelist count",this.updateDuelistCount.bind(this))},listenShipCommand:function(){this.socket.on("attack",this.attack.bind(this))},youHaveControl:function(data){this.controlShip=data.ship,this.socket.emit("I have control",{ship:this.controlShip}),"undefined"!=typeof console&&console.log("I have control: "+this.controlShip)},youHaveNoControl:function(data){(function(){this.socket.emit("duty",{})}).bind(this).delay(5)},updateDuelistCount:function(cnt){this.duelistCounter.update("Duelists: "+cnt)},attack:function(data){this.cmds[data.color]&&(data.color!=this.controlShip&&this.critical(data),this.ships[data.color].nextCmd=data.cmd,this.cmds[data.color].execute(data.cmd))},critical:function(data){var methodName="critical"+data.color.capitalize();this[methodName in this?methodName:"criticalDefault"](data)},criticalDefault:function(data){this.ships[data.color]&&(this.ships[data.color].setHitPoint(data.hp),"stepRight"!==this.ships[data.color].nextCmd&&"stepLeft"!==this.ships[data.color].nextCmd&&this.ships[data.color].setLeft(this.ships[data.color].clientWidth-data.left-90))},criticalRed:function(data){if(this.ships.red&&(this.ships.red.setHitPoint(data.hp),"stepRight"!==this.ships.red.nextCmd&&"stepLeft"!==this.ships.red.nextCmd&&this.ships.red.setLeft(this.ships.red.clientWidth-data.left-90),data.iField.isActive?(this.ships.red.iField.setHeight(data.iField.height),this.ships.red.iField.invoke()):this.ships.red.iField.cancel(),this.weapons.red)){null===data.funnel.firstLeft&&null===data.funnel.secondLeft&&this.weapons.red.removeFunnelCircle(2),null!==data.funnel.firstLeft&&null===data.funnel.secondLeft&&2===this.weapons.red.funnelCircles.size()&&this.weapons.red.removeFunnelCircle(1);var left;null!==data.funnel.firstLeft&&(0===this.weapons.red.funnelCircles.size()&&this.weapons.red.addFunnelCircle(),left=this.ships.red.clientWidth-data.funnel.firstLeft-30,left!==this.ships.red.funnels[0].initLeft&&(this.ships.red.funnels[0].initLeft=left),this.ships.red.funnels[0].theta=data.funnel.firstTheta),null!==data.funnel.secondLeft&&(1===this.weapons.red.funnelCircles.size()&&this.weapons.red.addFunnelCircle(),left=this.ships.red.clientWidth-data.funnel.secondLeft-30,left!==this.ships.red.funnels[1].initLeft&&(this.ships.red.funnels[1].initLeft=left),this.ships.red.funnels[1].theta=data.funnel.secondTheta)}},pushAttackInfo:function(cmd){if(cmd){var data={color:this.controlShip,cmd:cmd,hp:this.ships[this.controlShip].getHitPoint(),left:this.ships[this.controlShip].getLeft()};"red"==this.controlShip&&(data.iField=this.ships.red.getIFieldInfo(),data.funnel=this.ships.red.getFunnelInfo()),this.socket.emit("attack",data)}},setShipAndCommand:function(color,ship,cmd){this.ships[color]=ship,this.cmds[color]=cmd},setShipRedWeapon:function(weapon){this.weapons.red=weapon},stop:function(){this.socket.disconnect(),this.chatForm.elm.disable(),this.chatForm.elm.stopObserving("submit")}}),Chat=Class.create({elms:null,initialize:function(){this.elms=[]},add:function(text){var elm=new NicoNico(text);elm.renderElement(),this.elms.push(elm)},move:function(){for(var i=0,len=this.elms.size();i<len;i++)this.elms[i].move(),this.elms[i].isDelete&&(this.elms[i]=null);this.elms=this.elms.compact()}}),Weapon=Class.create({FUNNEL_SLIDER_MAX:5,FUNNEL_CIRCLE_MAX:2,MEGA_CANNON_WAIT:250,MEGA_CANNON_HEIGHT:29,ship:null,enemy:null,funnelSliderCount:null,funnelCircles:null,megaCannonWaitCount:null,megaCannonHeightCount:null,soundFunnelGo:null,soundFunnelAttack:null,soundAttack:null,soundMegaCannon:null,elms:null,initialize:function(ship,enemy){this.ship=ship,this.enemy=enemy,this.funnelSliderCount=0,this.funnelCircles=[],this.megaCannonWaitCount=0,this.megaCannonHeightCount=0,this.elms=[]},move:function(){0<this.megaCannonWaitCount&&(--this.megaCannonWaitCount,this.megaCannonWaitCount||this.ship.enableMegaCannonStatus()),0<this.megaCannonHeightCount&&(this.megaCannonHeightCount%3===0&&this.addBulletLinearFromMegaCannon(),--this.megaCannonHeightCount),this.funnelCircles.each(function(x){x.move()});for(var i=0,len=this.elms.size();i<len;i++)this.elms[i].move(),this.elms[i].isFunnelSliderAttack&&(this.addBulletLinearFromFunnel(this.elms[i].getLeft()),this.elms[i].isFunnelSliderAttack=!1),this.elms[i].isWeaponWaitStatusMegaCannon&&this.elms[i].setWidth(this.megaCannonWaitCount,this.MEGA_CANNON_WAIT),this.elms[i].isFunnelSlider&&(this.funnelSliderCount<=this.FUNNEL_SLIDER_MAX?this.ship.enableFunnelStatus():this.ship.disableFunnelStatus()),this.elms[i].isDelete&&(this.elms[i].isFunnelSlider&&--this.funnelSliderCount,this.elms[i]=null);this.elms=this.elms.compact()},setSoundFunnelGo:function(audio){this.soundFunnelGo=audio},setSoundFunnelAttack:function(audio){this.soundFunnelAttack=audio},setSoundAttack:function(audio){this.soundAttack=audio},setSoundMegaCannon:function(audio){this.soundMegaCannon=audio},playSoundFunnelGo:function(audio){this.soundFunnelGo&&this.soundFunnelGo.replay()},playSoundFunnelAttack:function(){this.soundFunnelAttack&&this.soundFunnelAttack.replay()},playSoundAttack:function(){this.soundAttack&&this.soundAttack.replay()},playSoundMegaCannon:function(){this.soundMegaCannon&&this.soundMegaCannon.replay()},addBulletLinear:function(){var elm=new BulletLinear(this.ship,this.enemy);this.elms.push(elm),elm.renderElement(),this.playSoundAttack()},addBulletHoming:function(){var elm=new BulletHoming(this.ship,this.enemy);this.elms.push(elm),elm.renderElement(),this.playSoundAttack()},addBulletBezierAuto:function(){var enemyLeft=this.enemy.getLeft(),elmL=new BulletBezier(this.ship,this.enemy,enemyLeft-60),elmC=new BulletBezier(this.ship,this.enemy,enemyLeft+30),elmR=new BulletBezier(this.ship,this.enemy,enemyLeft+120);this.elms.push(elmL),this.elms.push(elmC),this.elms.push(elmR),elmL.renderElement(),elmC.renderElement(),elmR.renderElement(),this.playSoundAttack()},addBulletBezierManual:function(left){var elm=new BulletBezier(this.ship,this.enemy,left);this.elms.push(elm),elm.renderElement(),this.playSoundAttack()},addBulletLinearFromFunnel:function(left){var elm=new BulletLinear(this.ship,this.enemy);elm.setPos({top:this.ship.isEnemy?90:elm.clientHeight-120,left:left}),this.elms.push(elm),elm.renderElement(),this.playSoundFunnelAttack()},addBulletLinearFromMegaCannon:function(){var elmL=new BulletLinear(this.ship,this.enemy),elmM=new BulletLinear(this.ship,this.enemy),elmR=new BulletLinear(this.ship,this.enemy);elmL.setPos({top:this.ship.isEnemy?60:this.ship.clientHeight-90,left:this.ship.getLeft()}),elmM.setPos({top:this.ship.isEnemy?60:this.ship.clientHeight-90,left:this.ship.getLeft()+30}),elmR.setPos({top:this.ship.isEnemy?60:this.ship.clientHeight-90,left:this.ship.getLeft()+60}),this.elms.push(elmL),this.elms.push(elmM),this.elms.push(elmR),elmL.renderElement(),elmM.renderElement(),elmR.renderElement()},addBulletHomingFromFunnel:function(top,left){var elm=new BulletHoming(this.ship,this.enemy);elm.setPos({top:top,left:left}),this.elms.push(elm),elm.renderElement()},addFunnelSlider:function(){if(!(this.FUNNEL_SLIDER_MAX<=this.funnelSliderCount)){var elm=new FunnelSlider(this.ship,this.enemy);this.elms.push(elm),++this.funnelSliderCount,elm.renderElement(),this.playSoundFunnelGo()}},addFunnelCircle:function(){if(this.FUNNEL_CIRCLE_MAX<=this.funnelCircles.size())return this.funnelCircles.each(function(x){this.addBulletHomingFromFunnel(x.getTop()+(x.isEnemy?30:-30),x.getLeft())}.bind(this)),void this.playSoundFunnelAttack();var funnel=new FunnelCircle(this.ship);this.ship.addFunnel(funnel),this.funnelCircles.push(funnel),funnel.renderElement(),this.playSoundFunnelGo()},addIField:function(audio){var iField=new IField(this.ship),wws=new WeaponWaitStatusIField(this.ship);iField.setSound(audio),iField.setWaitStatus(wws),this.elms.push(iField),this.elms.push(wws),iField.renderElement(),wws.renderElement()},addFunnelDefences:function(){var l=new FunnelDefenceLeft(this.ship,this.ship.getIField()),r=new FunnelDefenceRight(this.ship,this.ship.getIField());this.elms.push(l),this.elms.push(r),l.renderElement(),r.renderElement()},addWeaponWaitStatusMegaCannon:function(){var wws=new WeaponWaitStatusMegaCannon(this.ship);this.elms.push(wws),wws.renderElement()},removeFunnelCircle:function(num){var elm;elm=this.funnelCircles.shift(),elm&&elm.remove(),this.ship.funnels.shift(),1<num&&(elm=this.funnelCircles.shift(),elm&&elm.remove(),this.ship.funnels.shift())},fireMegaCannon:function(){0<this.megaCannonWaitCount||(this.ship.disableMegaCannonStatus(),this.megaCannonWaitCount=this.MEGA_CANNON_WAIT,this.megaCannonHeightCount=this.MEGA_CANNON_HEIGHT,this.playSoundMegaCannon())}});
//# sourceMappingURL=source.map